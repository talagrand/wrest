name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  MSRV: '1.90'

jobs:
  test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # -- Windows - native WinHTTP backend -----------------------
          - { name: 'win / msrv / no-defaults',   os: windows-latest, rust: msrv,   mode: no-defaults }
          - { name: 'win / msrv / defaults',       os: windows-latest, rust: msrv,   mode: defaults }
          - { name: 'win / stable / no-defaults',  os: windows-latest, rust: stable, mode: no-defaults }
          - { name: 'win / stable / all-native',   os: windows-latest, rust: stable, mode: all, doc-tests: true }
          # -- Windows - reqwest passthrough (via always-reqwest) -----
          - { name: 'win / stable / reqwest',      os: windows-latest, rust: stable, mode: all-reqwest }
          # -- Linux - reqwest passthrough (implicit, no always-reqwest needed)
          - { name: 'linux / msrv / no-defaults',  os: ubuntu-latest,  rust: msrv,   mode: no-defaults }
          - { name: 'linux / msrv / defaults',      os: ubuntu-latest,  rust: msrv,   mode: defaults }
          - { name: 'linux / stable / no-defaults', os: ubuntu-latest,  rust: stable, mode: no-defaults }
          - { name: 'linux / stable / all',         os: ubuntu-latest,  rust: stable, mode: all }

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Resolve matrix parameters
      id: resolve
      shell: bash
      run: |
        # Toolchain
        rust="${{ matrix.rust }}"
        [[ "$rust" == "msrv" ]] && rust="$MSRV"
        echo "toolchain=$rust" >> "$GITHUB_OUTPUT"

        # Cargo feature flags
        case "${{ matrix.mode }}" in
          no-defaults)  echo "flags=--no-default-features" ;;
          defaults)     echo "flags=" ;;
          all)          echo "flags=--features __all-native-features" ;;
          all-reqwest)  echo "flags=--features __all-native-features,always-reqwest" ;;
        esac >> "$GITHUB_OUTPUT"

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ steps.resolve.outputs.toolchain }}

    - name: Install clippy
      if: matrix.rust == 'stable'
      run: rustup component add clippy

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Run tests
      run: cargo test --all-targets ${{ steps.resolve.outputs.flags }} --verbose

    - name: Run clippy
      if: matrix.rust == 'stable'
      run: cargo clippy --all-targets ${{ steps.resolve.outputs.flags }} -- -D warnings

    - name: Run doc tests
      if: matrix.doc-tests
      run: cargo test --doc --features __all-native-features

  fmt:
    name: Formatting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt

    - name: Check formatting
      run: cargo fmt --all -- --check

  docs:
    name: Documentation
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Build documentation
      run: cargo doc --features __all-native-features --no-deps

  coverage:
    name: Coverage
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2

    - name: Generate coverage
      run: cargo llvm-cov --features __all-native-features --lcov --output-path lcov.info

    - name: Upload to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: lcov.info
        fail_ci_if_error: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install cargo-audit
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-audit

    - name: Run security audit
      run: cargo audit

  minimal-versions:
    name: Minimal Versions (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { name: native,  os: windows-latest }
          - { name: reqwest, os: ubuntu-latest }

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@nightly

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-hack and cargo-minimal-versions
      uses: taiki-e/install-action@v2
      with:
        tool: cargo-hack,cargo-minimal-versions

    - name: Check minimal versions
      shell: bash
      run: cargo +nightly minimal-versions check --direct --features __all-native-features
